#run
#terraform init
#terraform apply -var "do_token=your_do_api_token" -var ssh_key="$(cat path/to/key.pub)"

terraform {
required_providers {
digitalocean = {
  source = "digitalocean/digitalocean"
}
}
}

provider "digitalocean" {
  token = var.do_token
}

variable "do_token" {}

variable "ssh_key" {
  default = "spraykey"  # Replace with your actual SSH public key
}

variable "droplet_names" {
  default = ["rizzler", "aj", "bigjustice"]
}

resource "digitalocean_ssh_key" "my_key" {
  name       = "spraykey"
  public_key = var.ssh_key
}

resource "digitalocean_firewall" "allow_internal_ssh" {
  name = "allow-internal-ssh"

  inbound_rule {
    protocol         = "tcp"
    port_range       = "22"
    source_addresses = ["10.0.0.0/8", "192.168.0.0/16"] # Allow internal SSH
  }

  outbound_rule {
    protocol         = "tcp"
    port_range       = "all"
    destination_addresses = ["0.0.0.0/0"]
  }

  droplet_ids = [for droplet in digitalocean_droplet.red_team : droplet.id]
}

resource "digitalocean_droplet" "red_team" {
  count = 3
  name  = var.droplet_names[count.index]
  region = "nyc3"  # Change region if needed
  size   = "s-2vcpu-4gb"  # Adjust size as needed
  image  = "ubuntu-22-04-x64"

  ssh_keys = [digitalocean_ssh_key.my_key.fingerprint]

  user_data = <<-EOF
    #!/bin/bash
    apt update && apt upgrade -y
    apt install -y python3 python3-pip
    pip3 install trevorspray trevorproxy
  EOF
}
